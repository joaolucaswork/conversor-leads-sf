<!DOCTYPE html>
<html>
<head>
    <title>OAuth Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Salesforce OAuth Test</h1>
    
    <div>
        <button onclick="testElectronAPI()">Test Electron API</button>
        <button onclick="testSalesforceAuth()">Test Salesforce Auth URL</button>
        <button onclick="testStoreValue()">Test Store Value</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
    
    <div id="output" class="output"></div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function testElectronAPI() {
            log('Testing Electron API availability...');
            
            if (typeof window.electronAPI === 'undefined') {
                log('❌ window.electronAPI is not available', 'error');
                return;
            }
            
            log('✅ window.electronAPI is available', 'success');
            log('Available methods: ' + Object.keys(window.electronAPI).join(', '));
            
            // Test specific methods
            const requiredMethods = [
                'getSalesforceAuthUrl',
                'sendSalesforceOpenAuthWindow',
                'salesforceExchangeCode',
                'getStoreValue',
                'setStoreValue'
            ];
            
            requiredMethods.forEach(method => {
                if (typeof window.electronAPI[method] === 'function') {
                    log(`✅ ${method} is available`, 'success');
                } else {
                    log(`❌ ${method} is NOT available`, 'error');
                }
            });
        }

        async function testSalesforceAuth() {
            log('Testing Salesforce Auth URL generation...');
            
            if (!window.electronAPI || !window.electronAPI.getSalesforceAuthUrl) {
                log('❌ getSalesforceAuthUrl not available', 'error');
                return;
            }
            
            try {
                const authUrl = await window.electronAPI.getSalesforceAuthUrl();
                if (authUrl) {
                    log('✅ Auth URL generated successfully', 'success');
                    log('Auth URL: ' + authUrl);
                    
                    // Check if URL contains PKCE parameters
                    if (authUrl.includes('code_challenge=')) {
                        log('✅ PKCE code_challenge found in URL', 'success');
                    } else {
                        log('❌ PKCE code_challenge NOT found in URL', 'error');
                    }
                    
                    if (authUrl.includes('code_challenge_method=S256')) {
                        log('✅ PKCE method S256 found in URL', 'success');
                    } else {
                        log('❌ PKCE method S256 NOT found in URL', 'error');
                    }
                } else {
                    log('❌ Auth URL is null or empty', 'error');
                }
            } catch (error) {
                log('❌ Error generating auth URL: ' + error.message, 'error');
            }
        }

        async function testStoreValue() {
            log('Testing Store Value functions...');
            
            if (!window.electronAPI || !window.electronAPI.getStoreValue || !window.electronAPI.setStoreValue) {
                log('❌ Store value functions not available', 'error');
                return;
            }
            
            try {
                // Test setting a value
                await window.electronAPI.setStoreValue('test-key', 'test-value');
                log('✅ Successfully set test value', 'success');
                
                // Test getting the value
                const value = await window.electronAPI.getStoreValue('test-key');
                if (value === 'test-value') {
                    log('✅ Successfully retrieved test value: ' + value, 'success');
                } else {
                    log('❌ Retrieved value does not match: ' + value, 'error');
                }
            } catch (error) {
                log('❌ Error with store value functions: ' + error.message, 'error');
            }
        }

        // Setup OAuth listeners
        if (window.electronAPI && window.electronAPI.onSalesforceOAuthCallback) {
            window.electronAPI.onSalesforceOAuthCallback((code) => {
                log('🎉 OAuth callback received with code: ' + code, 'success');
            });
            
            window.electronAPI.onSalesforceOAuthError((error) => {
                log('❌ OAuth error received: ' + JSON.stringify(error), 'error');
            });
            
            log('✅ OAuth listeners setup successfully', 'success');
        } else {
            log('❌ OAuth listeners could not be setup', 'error');
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            log('🚀 Starting OAuth integration tests...');
            setTimeout(() => {
                testElectronAPI();
                setTimeout(() => {
                    testSalesforceAuth();
                    setTimeout(() => {
                        testStoreValue();
                    }, 1000);
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>
